<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>💰 Gestionnaire de Budget — v07 (mapping + XLSX + table)</title>
  <meta name="description" content="Gestionnaire de budget : import CSV (auto/manuel), exports CSV/JSON/XLSX, édition, tableaux triables avec pagination, et graphiques.">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <style>
    :root{
      --primary:#1976d2; --primary-600:#1565c0; --green:#4caf50; --green-700:#2e7d32;
      --red:#f44336; --orange:#ff9800; --bg:linear-gradient(135deg,#e3f2fd 0%,#bbdefb 100%);
      --card:#fff; --muted:#666; --border:#e0e0e0; --shadow:0 6px 18px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);padding:24px;min-height:100vh}
    .container{max-width:1200px;margin:0 auto}
    .header{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:20px 24px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;gap:16px}
    .header h1{font-size:1.6rem;color:var(--primary);display:flex;gap:.5rem;align-items:center}
    .solde{font-size:1.4rem;font-weight:800}
    .solde.positif{color:var(--green-700,#2e7d32)} .solde.negatif{color:var(--red)}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px}
    .tab-btn{background:var(--card);border:2px solid transparent;border-radius:10px;padding:10px 14px;cursor:pointer;color:#444;font-weight:600;box-shadow:var(--shadow);transition:.2s}
    .tab-btn[aria-selected="true"]{border-color:var(--primary);background:#e3f2fd;color:var(--primary)}
    .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:20px}
    .grid{display:grid;gap:16px}
    .grid-3{grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .kpi{border-left:6px solid; padding:16px 16px 14px;border-radius:12px;border-color:var(--primary);background:#eef6ff}
    .kpi.revenus{border-color:var(--green);background:#e8f5e8}
    .kpi.depenses{border-color:var(--red);background:#ffebee}
    .kpi h3{font-size:.95rem;margin:0 0 4px} .kpi .v{font-size:1.3rem;font-weight:800}
    .muted{color:var(--muted)} .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;transition:.15s}
    .btn.primary{background:var(--primary);color:#fff}.btn.primary:hover{background:var(--primary-600)}
    .btn.green{background:var(--green);color:#fff}.btn.green:hover{background:#3e9c44}
    .btn.red{background:var(--red);color:#fff}.btn.red:hover{filter:brightness(.95)}
    .btn.orange{background:var(--orange);color:#fff}
    .btn.ghost{background:#f5f7fb}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-weight:700;color:#333}
    input,select,textarea{width:100%;padding:12px;border:2px solid #ddd;border-radius:10px;font-size:1rem;transition:.15s;background:#fff}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary)}
    .two{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media (max-width:900px){.two{grid-template-columns:1fr}}
    .list{display:flex;flex-direction:column;gap:10px}
    .line{display:grid;grid-template-columns:auto 1fr auto auto auto;gap:12px;align-items:center;border:1px solid var(--border);background:#fff;border-radius:12px;padding:12px}
    .dot{width:10px;height:10px;border-radius:50%}.dot.revenu{background:var(--green)}.dot.depense{background:var(--red)}
    .line .desc{font-weight:700}.line .date{font-size:.85rem;color:var(--muted)}
    .amt{font-weight:800;text-align:right}.amt.revenu{color:var(--green)}.amt.depense{color:var(--red)}
    .select-budget{min-width:210px}
    .select-budget.non{border-color:var(--red);background:#fff5f5}.select-budget.ok{border-color:var(--green);background:#f7fff7}
    .empty{text-align:center;color:var(--muted);padding:28px 8px}
    .alert{padding:12px 14px;border-radius:10px}
    .alert.red{background:#ffebee;border:1px solid var(--red);color:var(--red)}
    .alert.orange{background:#fff8e1;border:1px solid #f57c00;color:#f57c00}
    .alert.blue{background:#e3f2fd;border:1px solid var(--primary);color:var(--primary)}
    .budget-item{background:#f8f9fb;border-left:6px solid var(--primary);padding:16px;border-radius:12px;display:grid;gap:10px}
    .budget-head{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .progress{height:14px;background:#e0e0e0;border-radius:10px;overflow:hidden}
    .bar{height:100%}
    .bar.ok{background:linear-gradient(90deg,#4caf50,#66bb6a)}.bar.warn{background:linear-gradient(90deg,#ff9800,#ffb74d)}.bar.bad{background:linear-gradient(90deg,#f44336,#ef9a9a)}
    .search{max-width:440px;margin:0 auto}
    .file-drop{border:2px dashed var(--primary);border-radius:12px;padding:28px;text-align:center;background:#f8fbff}
    .file-drop.drag{background:#e3f2fd;border-color:var(--primary-600)}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{font-size:.8rem;background:#eef2f7;border:1px solid #dde3ea;padding:6px 10px;border-radius:999px}
    details>summary{cursor:pointer;user-select:none;font-weight:700;margin:-6px 0 8px}
    .badge{font-size:.78rem;border-radius:8px;padding:4px 8px;background:#eef2f7;border:1px solid #dde3ea}
    .badge.rec{background:#e8f5e8;border-color:#c8e6c9}
    .right{justify-content:flex-end}

    /* Table triable + pagination */
    table{width:100%; border-collapse:separate; border-spacing:0; background:#fff; border:1px solid var(--border); border-radius:12px; overflow:hidden}
    th, td{padding:10px 12px; border-bottom:1px solid #eee; text-align:left; font-size:.95rem}
    thead th{background:#f5f7fb; font-weight:800; cursor:pointer; user-select:none}
    thead th.sort-asc::after{content:"▲"; float:right; font-size:.75rem}
    thead th.sort-desc::after{content:"▼"; float:right; font-size:.75rem}
    tbody tr:hover{background:#fafcff}
    .table-controls{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:10px}
    .pagination{display:flex; gap:6px; align-items:center}
    .pagination button{padding:6px 10px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer}
    .pagination .active{background:#e3f2fd; border-color:var(--primary); color:var(--primary); font-weight:800}
    .mode-toggle{display:flex; gap:8px; align-items:center}
  </style>
</head>
<body>
  <div class="container">
    <div class="header" role="banner">
      <h1>💰 Gestionnaire de Budget <span class="badge">v07</span></h1>
      <div id="solde-display" class="solde positif">+0,00 €</div>
    </div>

    <nav class="tabs" role="tablist" aria-label="Sections">
      <button class="tab-btn" data-tab="dashboard" aria-selected="true">📊 Tableau de bord</button>
      <button class="tab-btn" data-tab="budgets">🎯 Budgets</button>
      <button class="tab-btn" data-tab="add">➕ Ajouter</button>
      <button class="tab-btn" data-tab="history">📋 Historique</button>
      <button class="tab-btn" data-tab="search">🔍 Rechercher</button>
      <button class="tab-btn" data-tab="import">📥 Import</button>
      <button class="tab-btn" data-tab="export">📤 Export</button>
      <button class="tab-btn" data-tab="charts">📈 Graphiques</button>
      <button class="tab-btn" data-tab="prefs">⚙️ Réglages</button>
    </nav>

    <section id="dashboard" class="card tab" role="tabpanel">
      <div class="grid grid-3">
        <div class="kpi revenus">
          <h3>💰 Total Revenus</h3>
          <div id="kpi-revenus" class="v">+0,00 €</div>
          <div class="muted" id="kpi-revenus-nb">0 ligne</div>
        </div>
        <div class="kpi depenses">
          <h3>💸 Total Dépenses</h3>
          <div id="kpi-depenses" class="v">-0,00 €</div>
          <div class="muted" id="kpi-depenses-nb">0 ligne</div>
        </div>
        <div class="kpi">
          <h3>💼 Solde</h3>
          <div id="kpi-solde" class="v">+0,00 €</div>
          <div class="muted">Ce mois</div>
        </div>
      </div>
      <div id="alerts" class="grid" style="margin-top:16px"></div>

      <h3 style="margin:18px 0 8px">🎯 Dernières transactions — Affectation rapide</h3>
      <div id="recent-list" class="list"></div>
    </section>

    <section id="budgets" class="card tab" hidden role="tabpanel">
      <div class="alert blue">Définissez vos budgets mensuels par catégorie. Les transactions du mois en cours alimentent la jauge automatiquement.</div>
      <div class="two">
        <div class="card">
          <h3>➕ Nouveau budget</h3>
          <div class="grid" style="grid-template-columns:1fr 160px auto;align-items:end;margin-top:8px">
            <div>
              <label for="budget-categorie">Catégorie</label>
              <input id="budget-categorie" placeholder="Ex: Alimentation, Transport, Loisirs…">
            </div>
            <div>
              <label for="budget-montant">Montant mensuel (€)</label>
              <input id="budget-montant" type="number" step="0.01" min="0" placeholder="0.00">
            </div>
            <div><button class="btn primary" id="btn-add-budget">Créer le budget</button></div>
          </div>
        </div>
        <div class="card">
          <h3>Conseils</h3>
          <ul class="muted" style="margin:8px 0 0 18px">
            <li>Créez d’abord 3–5 catégories majeures.</li>
            <li>Surveillez les alertes quand vous dépassez 80% ou 100%.</li>
            <li>Vous pouvez supprimer un budget : les transactions restent mais la catégorie est effacée.</li>
          </ul>
        </div>
      </div>
      <div id="budgets-list" class="grid" style="margin-top:16px"></div>
    </section>

    <section id="add" class="card tab" hidden role="tabpanel">
      <h3>➕ Ajouter une transaction</h3>
      <div class="two" style="margin-top:8px">
        <div class="card">
          <div class="grid" style="grid-template-columns: 140px 1fr">
            <div>
              <label for="montant">Montant (€)</label>
              <input id="montant" type="number" step="0.01" min="0" placeholder="0.00">
            </div>
            <div>
              <label for="description">Description</label>
              <input id="description" placeholder="Ex: Courses, Salaire, Internet…">
            </div>
            <div style="grid-column:1/-1">
              <label for="categorie">Budget (dépenses)</label>
              <select id="categorie" class="select-budget"></select>
            </div>
          </div>
          <div class="actions right" style="margin-top:10px">
            <button class="btn green" id="btn-add-revenu">Ajouter revenu</button>
            <button class="btn red" id="btn-add-depense">Ajouter dépense</button>
          </div>
        </div>
        <div class="card">
          <h3>Astuce</h3>
          <p class="muted">Les revenus n’ont pas de catégorie. Pour les dépenses, choisissez un budget ou laissez vide pour affecter plus tard.</p>
          <div class="chips">
            <span class="chip">⌘/Ctrl+K : Rechercher</span>
            <span class="chip">⌘/Ctrl+E : Export</span>
            <span class="chip">⌘/Ctrl+I : Import</span>
          </div>
        </div>
      </div>
    </section>

    <section id="history" class="card tab" hidden role="tabpanel">
      <div class="table-controls">
        <div class="mode-toggle">
          <label>Affichage :</label>
          <select id="history-mode">
            <option value="list">Liste</option>
            <option value="table">Tableau</option>
          </select>
        </div>
        <div style="display:flex; gap:8px; align-items:center">
          <input id="history-filter" placeholder="Filtrer (desc/catégorie)…" style="max-width:260px">
          <label>Page :</label>
          <select id="history-pagesize" style="width:auto">
            <option>10</option><option>25</option><option>50</option><option>100</option>
          </select>
        </div>
      </div>
      <div id="history-list" class="list"></div>
      <div id="history-table-wrap" hidden>
        <table>
          <thead>
            <tr>
              <th data-key="date">Date</th>
              <th data-key="description">Description</th>
              <th data-key="type">Type</th>
              <th data-key="montant">Montant</th>
              <th data-key="categorie">Catégorie</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="history-tbody"></tbody>
        </table>
        <div class="pagination" id="history-pagination" style="margin-top:10px"></div>
      </div>
    </section>

    <section id="search" class="card tab" hidden role="tabpanel">
      <h3>🔍 Rechercher & affecter</h3>
      <input id="search-input" class="search" placeholder="Rechercher par description ou catégorie…" />
      <div id="search-results" class="list" style="margin-top:14px"></div>
    </section>

    <section id="import" class="card tab" hidden role="tabpanel">
      <h3>📥 Importer un CSV</h3>
      <div class="file-drop" id="drop">
        <p style="font-size:1.1rem;margin:0 0 6px">Cliquez pour choisir un fichier CSV<br><span class="muted">ou glissez-déposez-le ici</span></p>
        <input id="csvFile" type="file" accept=".csv,text/csv" hidden>
        <div class="chips" style="margin-top:8px">
          <span class="chip">Délimiteurs: , ; ⇥ | (auto ou manuel)</span>
          <span class="chip">Guillemets: "…"</span>
          <span class="chip">Dates: JJ/MM/AAAA, AAAA-MM-JJ</span>
          <span class="chip">Montants FR/US & Débit/Crédit</span>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h4>Mode d’analyse</h4>
        <div class="row">
          <label><input type="radio" name="mode" value="auto" checked> Auto (recommandé)</label>
          <label><input type="radio" name="mode" value="manuel"> Manuel (mapping de colonnes)</label>
        </div>
        <div id="manual-mapping" style="margin-top:12px; display:none">
          <div class="row"><b>Mapping des colonnes</b><span class="muted">— Choisissez les colonnes correspondantes</span></div>
          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); margin-top:8px">
            <div><label>Date</label><select id="map-date"></select></div>
            <div><label>Description</label><select id="map-desc"></select></div>
            <div>
              <label>Montant unique</label><select id="map-amount"></select>
              <div class="muted" style="font-size:.85rem">ou utilisez Débit/Crédit ci-dessous</div>
            </div>
            <div><label>Débit</label><select id="map-debit"></select></div>
            <div><label>Crédit</label><select id="map-credit"></select></div>
            <div><label>Catégorie (optionnel)</label><select id="map-cat"></select></div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn ghost" id="btn-preview-map">Aperçu (10 lignes)</button>
          </div>
          <div id="preview-map" class="alert blue" style="display:none; margin-top:10px"></div>
        </div>
      </div>

      <div class="actions" style="margin-top:12px">
        <button id="btn-import" class="btn primary" disabled>Importer</button>
        <button id="btn-clear-file" class="btn ghost">Vider la sélection</button>
      </div>
      <div id="import-results" class="alert blue" style="display:none;margin-top:12px"></div>
    </section>

    <section id="export" class="card tab" hidden role="tabpanel">
      <h3>📤 Export</h3>
      <div class="grid grid-3" style="margin-top:8px">
        <div class="card">
          <h4>Transactions</h4>
          <div class="actions" style="margin-top:10px">
            <button class="btn primary" id="export-tx-csv">CSV</button>
            <button class="btn ghost" id="export-tx-json">JSON</button>
            <button class="btn orange" id="export-tx-xlsx">XLSX</button>
          </div>
        </div>
        <div class="card">
          <h4>Budgets</h4>
          <div class="actions" style="margin-top:10px">
            <button class="btn primary" id="export-bud-csv">CSV</button>
            <button class="btn ghost" id="export-bud-json">JSON</button>
            <button class="btn orange" id="export-bud-xlsx">XLSX</button>
          </div>
        </div>
        <div class="card">
          <h4>Maintenance</h4>
          <div class="actions" style="margin-top:10px">
            <button class="btn red" id="reset-data">Réinitialiser les données</button>
          </div>
          <p class="muted" style="margin-top:6px">⚠️ Vide les transactions et budgets (localStorage).</p>
        </div>
      </div>
    </section>

    <section id="charts" class="card tab" hidden role="tabpanel">
      <h3>📈 Graphiques</h3>
      <p class="muted">Cliquez une part du camembert pour afficher le détail des transactions.</p>
      <div class="grid" style="grid-template-columns: 1fr 1fr">
        <div class="card"><canvas id="pie-categories" height="220"></canvas></div>
        <div class="card"><canvas id="line-mensuel" height="220"></canvas></div>
      </div>
      <details style="margin-top:12px">
        <summary>🧾 Détail de la sélection</summary>
        <div id="chart-detail" class="list" style="margin-top:10px"></div>
      </details>
    </section>

    <section id="prefs" class="card tab" hidden role="tabpanel">
      <h3>⚙️ Réglages</h3>
      <div class="grid grid-3" style="margin-top:8px">
        <div class="card">
          <h4>Affichage</h4>
          <label>Onglet par défaut</label>
          <select id="pref-default-tab">
            <option value="dashboard">Tableau de bord</option>
            <option value="budgets">Budgets</option>
            <option value="add">Ajouter</option>
            <option value="history">Historique</option>
            <option value="search">Rechercher</option>
            <option value="import">Import</option>
            <option value="export">Export</option>
            <option value="charts">Graphiques</option>
          </select>
        </div>
        <div class="card">
          <h4>Format</h4>
          <label>Langue/formatage</label>
          <select id="pref-locale">
            <option value="fr-FR">fr-FR</option>
            <option value="en-US">en-US</option>
            <option value="de-DE">de-DE</option>
          </select>
        </div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button class="btn primary" id="save-prefs">Enregistrer</button>
      </div>
    </section>
  </div>

  <!-- Chart.js + SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <script>
  // ====== ÉTAT ======
  let transactions = [];
  let budgets = [];
  let csvRaw = null; // {headers:[], rows:[[]], delim}
  let csvRows = null; // lignes normalisées prêtes à importer
  let pendingImport = null;
  let charts = { pie:null, line:null };

  let state = {
    historyMode: 'list',
    tableSort: {key:'date', dir:'desc'},
    tablePage: 1,
    tablePageSize: 10,
    tableFilter: ''
  };

  // ====== UTILITAIRES ======
  const LS_TX = 'budgetTransactions';
  const LS_BG = 'budgetBudgets';
  const LS_PREF = 'budgetPrefs';

  const $ = (id)=>document.getElementById(id);
  const fmt = (n)=> (n>=0?'+':'') + n.toLocaleString(getLocale(), {minimumFractionDigits:2, maximumFractionDigits:2}) + ' €';
  const fmtAbs = (n)=> Math.abs(n).toLocaleString(getLocale(), {minimumFractionDigits:2, maximumFractionDigits:2}) + ' €';
  const getLocale = ()=> (JSON.parse(localStorage.getItem(LS_PREF)||'{}').locale) || 'fr-FR';

  const today = ()=> new Date();
  const startOfMonth = (d=new Date())=> new Date(d.getFullYear(), d.getMonth(), 1);
  const parseMaybeDate = (str)=>{
    if(!str) return null;
    const s = (str+'').trim();
    let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/);
    if(m){ let y = parseInt(m[3],10); if(y<100) y+=2000; return new Date(y, parseInt(m[2],10)-1, parseInt(m[1],10)); }
    m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if(m) return new Date(parseInt(m[1],10), parseInt(m[2],10)-1, parseInt(m[3],10));
    const d = new Date(s);
    return isNaN(d.getTime()) ? null : d;
  };
  const sanitizeNumber = (raw)=>{
    if(raw===undefined||raw===null) return NaN;
    let s = (''+raw).trim().replace(/\u00A0/g,' ').replace(/\s+/g,' ');
    s = s.replace(/^[^\d\-]+/, '');
    if(/,\d{1,2}$/.test(s)){ s = s.replace(/\./g,'').replace(/\s/g,'').replace(',', '.'); }
    else{ s = s.replace(/,/g,''); }
    return parseFloat(s);
  };

  function saveAll(){
    localStorage.setItem(LS_TX, JSON.stringify(transactions));
    localStorage.setItem(LS_BG, JSON.stringify(budgets));
    const prefs = JSON.parse(localStorage.getItem(LS_PREF)||'{}');
    prefs.historyMode = state.historyMode;
    localStorage.setItem(LS_PREF, JSON.stringify(prefs));
  }
  function loadAll(){
    try{ transactions = JSON.parse(localStorage.getItem(LS_TX)||'[]'); }catch{ transactions=[]; }
    try{ budgets = JSON.parse(localStorage.getItem(LS_BG)||'[]'); }catch{ budgets=[]; }
    const prefs = JSON.parse(localStorage.getItem(LS_PREF)||'{}');
    if(prefs.locale){ $('pref-locale').value = prefs.locale; }
    if(prefs.defaultTab){ $('pref-default-tab').value = prefs.defaultTab; }
    if(prefs.historyMode){ state.historyMode = prefs.historyMode; }
    activateTab(prefs.defaultTab || 'dashboard');
    refreshAll();
  }

  // ====== CALCULS ======
  function totals(){
    const r = transactions.filter(t=>t.type==='revenu').reduce((s,t)=>s+t.montant,0);
    const d = transactions.filter(t=>t.type==='depense').reduce((s,t)=>s+t.montant,0);
    return {revenus:r, depenses:d, solde:r-d};
  }
  function monthSpendByCat(d = new Date()){
    const start = startOfMonth(d), map = {};
    for(const t of transactions){
      if(t.type==='depense' && new Date(t.date)>=start){
        const c = t.categorie||'— Sans budget';
        map[c] = (map[c]||0) + t.montant;
      }
    }
    return map;
  }
  function monthSeries(n=6){
    const out = [], base = new Date();
    for(let i=n-1;i>=0;i--){
      const dt = new Date(base.getFullYear(), base.getMonth()-i, 1);
      const next = new Date(base.getFullYear(), base.getMonth()-i+1, 1);
      let r=0,d=0;
      for(const t of transactions){
        const td = new Date(t.date);
        if(td>=dt && td<next){ if(t.type==='revenu') r+=t.montant; else d+=t.montant; }
      }
      out.push({label: dt.toLocaleDateString(getLocale(), {month:'short', year:'2-digit'}), revenus:r, depenses:d, solde:r-d});
    }
    return out;
  }
  function currentMonthUsage(cat){
    const start = startOfMonth();
    return transactions.filter(t=>t.type==='depense' && t.categorie===cat && new Date(t.date)>=start).reduce((s,t)=>s+t.montant,0);
  }

  // ====== UI RENDER ======
  function refreshKPIs(){
    const {revenus,depenses,solde} = totals();
    $('kpi-revenus').textContent = fmt(revenus);
    $('kpi-depenses').textContent = (depenses===0?'-':'') + fmtAbs(depenses);
    $('kpi-revenus-nb').textContent = transactions.filter(t=>t.type==='revenu').length + ' ligne(s)';
    $('kpi-depenses-nb').textContent = transactions.filter(t=>t.type==='depense').length + ' ligne(s)';
    $('kpi-solde').textContent = fmt(solde);
    const s = $('solde-display');
    s.textContent = fmt(solde);
    s.className = 'solde ' + (solde>=0?'positif':'negatif');
  }
  function renderAlerts(){
    const wrap = $('alerts'); wrap.innerHTML='';
    const nonAffectees = transactions.filter(t=>t.type==='depense' && !t.categorie).length;
    if(nonAffectees>0){
      wrap.insertAdjacentHTML('beforeend', `<div class="alert red">❌ <b>${nonAffectees} dépense(s) non affectée(s)</b> — utilisez les listes pour les assigner.</div>`);
    }
    for(const b of budgets){
      const dep = currentMonthUsage(b.categorie);
      const pct = b.montant>0 ? (dep/b.montant)*100 : 0;
      if(pct>=100){
        wrap.insertAdjacentHTML('beforeend', `<div class="alert red">🚨 <b>Budget dépassé</b> — ${b.categorie}: ${fmtAbs(dep)} / ${fmtAbs(b.montant)} (${pct.toFixed(0)}%)</div>`);
      }else if(pct>=80){
        wrap.insertAdjacentHTML('beforeend', `<div class="alert orange">⚠️ <b>Seuil 80%</b> — ${b.categorie}: ${fmtAbs(dep)} / ${fmtAbs(b.montant)} (${pct.toFixed(0)}%)</div>`);
      }
    }
  }
  function optionsBudget(current=''){
    let html = `<option value="">— Aucun budget —</option>`;
    for(const b of budgets){
      const dep = currentMonthUsage(b.categorie);
      const reste = Math.max(b.montant - dep, 0);
      const flag = reste<=0 ? '🚨' : (reste < b.montant*0.2 ? '⚠️' : '✅');
      const sel = (current===b.categorie)?'selected':'';
      html += `<option ${sel} value="${escapeHtml(b.categorie)}">${flag} ${escapeHtml(b.categorie)} (reste: ${Math.round(reste)}€)</option>`;
    }
    return html;
  }
  const escapeHtml = (s)=> (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

  function renderRecent(){
    const box = $('recent-list');
    if(transactions.length===0){
      box.innerHTML = `<div class="empty">Aucune transaction. <br><button class="btn primary" onclick="activateTab('add')">➕ Ajouter</button></div>`;
      return;
    }
    box.innerHTML = transactions.slice(0,8).map(t=> lineHTML(t)).join('');
  }
  function renderHistoryList(data=transactions){
    const box = $('history-list');
    if(data.length===0){ box.innerHTML = `<div class="empty">Aucun résultat.</div>`;return; }
    box.innerHTML = data.map(t=> lineHTML(t,true)).join('');
  }
  function lineHTML(t, withEdit=false){
    const affectee = (t.type==='revenu') || (t.type==='depense' && t.categorie);
    const clsSel = affectee? 'ok':'non';
    const recBadge = isRecurring(t) ? `<span class="badge rec">🔁 récurrent</span>` : '';
    return `<div class="line">
      <div class="dot ${t.type}"></div>
      <div>
        <div class="desc">${escapeHtml(t.description)} ${recBadge}</div>
        <div class="date">📅 ${new Date(t.date).toLocaleDateString(getLocale())}</div>
      </div>
      <div class="amt ${t.type}">${t.type==='revenu'?fmt(t.montant):('-'+fmtAbs(t.montant))}</div>
      ${t.type==='depense'
        ? `<select class="select-budget ${clsSel}" onchange="affecter(${t.id}, this.value)">${optionsBudget(t.categorie||'')}</select>`
        : `<div class="badge">💰 Revenu</div>`}
      <div class="actions">
        ${withEdit?`<button class="btn ghost" onclick="editTx(${t.id})">✏️</button>`:''}
        <button class="btn red" onclick="supprimer(${t.id})">🗑️</button>
      </div>
    </div>`;
  }

  // ====== TABLE TRI + PAGINATION ======
  function renderHistoryTable(){
    const wrapList = $('history-list');
    const wrapTable = $('history-table-wrap');
    wrapList.hidden = true; wrapTable.hidden = false;

    // Filter
    const q = state.tableFilter.trim().toLowerCase();
    let rows = transactions.slice();
    if(q){
      rows = rows.filter(t => (t.description||'').toLowerCase().includes(q) || (t.categorie||'').toLowerCase().includes(q));
    }
    // Sort
    const {key, dir} = state.tableSort;
    rows.sort((a,b)=>{
      let va, vb;
      switch(key){
        case 'date': va = new Date(a.date).getTime(); vb = new Date(b.date).getTime(); break;
        case 'montant': va = (a.type==='depense'?-a.montant:a.montant); vb = (b.type==='depense'?-b.montant:b.montant); break;
        default: va = (a[key]||'').toString().toLowerCase(); vb = (b[key]||'').toString().toLowerCase();
      }
      if(va<vb) return dir==='asc'?-1:1;
      if(va>vb) return dir==='asc'?1:-1;
      return 0;
    });

    // Pagination
    const size = state.tablePageSize;
    const total = rows.length;
    const pages = Math.max(1, Math.ceil(total/size));
    if(state.tablePage>pages) state.tablePage = pages;
    const start = (state.tablePage-1)*size;
    const pageRows = rows.slice(start, start+size);

    // Render header sort indicators
    document.querySelectorAll('#history-table-wrap thead th[data-key]').forEach(th=>{
      th.classList.remove('sort-asc','sort-desc');
      if(th.dataset.key===key){ th.classList.add(dir==='asc'?'sort-asc':'sort-desc'); }
    });

    // Render body
    const tbody = $('history-tbody');
    tbody.innerHTML = pageRows.map(t=>{
      const montantSigned = t.type==='depense' ? -t.montant : t.montant;
      const select = t.type==='depense'
        ? `<select onchange="affecter(${t.id}, this.value)">${optionsBudget(t.categorie||'')}</select>`
        : `<span class="badge">💰 Revenu</span>`;
      return `<tr>
        <td>${new Date(t.date).toLocaleDateString(getLocale())}</td>
        <td>${escapeHtml(t.description)}</td>
        <td>${t.type}</td>
        <td style="white-space:nowrap">${montantSigned>=0?fmt(montantSigned):('-'+fmtAbs(-montantSigned))}</td>
        <td>${select}</td>
        <td>
          <button class="btn ghost" onclick="editTx(${t.id})">✏️</button>
          <button class="btn red" onclick="supprimer(${t.id})">🗑️</button>
        </td>
      </tr>`;
    }).join('');

    // Pagination buttons
    const pag = $('history-pagination');
    let html = '';
    html += `<button ${state.tablePage===1?'disabled':''} onclick="gotoPage(${state.tablePage-1})">Préc.</button>`;
    const maxButtons = 7;
    let from = Math.max(1, state.tablePage - Math.floor(maxButtons/2));
    let to = Math.min(pages, from + maxButtons - 1);
    from = Math.max(1, to - maxButtons + 1);
    for(let p=from;p<=to;p++){
      html += `<button class="${p===state.tablePage?'active':''}" onclick="gotoPage(${p})">${p}</button>`;
    }
    html += `<button ${state.tablePage===pages?'disabled':''} onclick="gotoPage(${state.tablePage+1})">Suiv.</button>`;
    pag.innerHTML = html;
  }
  function gotoPage(p){ state.tablePage = Math.max(1, p); renderHistoryTable(); }

  // ====== CRUD ======
  function addTx(type){
    const montant = sanitizeNumber($('montant').value);
    const description = ($('description').value||'').trim();
    const cat = $('categorie').value || null;
    if(!(montant>0)){ alert('Le montant doit être positif.'); return; }
    if(!description){ alert('La description est obligatoire.'); return; }
    const tx = { id: Date.now(), date: new Date().toISOString(), montant, description, type, categorie: (type==='depense' ? cat : null) };
    transactions.unshift(tx);
    saveAll(); refreshAll();
    $('montant').value=''; $('description').value=''; $('categorie').value='';
    alert(type==='revenu' ? `✅ Revenu ajouté: ${fmt(montant)}` : `✅ Dépense ajoutée: -${fmtAbs(montant)}${cat?' → '+cat:''}`);
  }
  function affecter(id, cat){
    const t = transactions.find(x=>x.id===id);
    if(t && t.type==='depense'){ t.categorie = cat || null; saveAll(); refreshAll(); }
  }
  function supprimer(id){
    if(!confirm('Supprimer cette transaction ?')) return;
    transactions = transactions.filter(t=>t.id!==id); saveAll(); refreshAll();
  }
  function editTx(id){
    const t = transactions.find(x=>x.id===id); if(!t) return;
    const desc = prompt('Description', t.description); if(desc===null) return;
    let amt = prompt('Montant (€)', t.montant); if(amt===null) return;
    const v = sanitizeNumber(amt);
    if(!(v>0)){ alert('Montant invalide'); return; }
    t.description = desc.trim(); t.montant = v;
    saveAll(); refreshAll();
  }

  // ====== BUDGETS ======
  function addBudget(){
    const cat = ($('budget-categorie').value||'').trim();
    const amount = sanitizeNumber($('budget-montant').value);
    if(!cat){ alert('Catégorie obligatoire'); return; }
    if(!(amount>0)){ alert('Montant invalide'); return; }
    if(budgets.some(b=>b.categorie.toLowerCase()===cat.toLowerCase())){ alert('Budget déjà existant'); return; }
    budgets.push({id:Date.now(), categorie:cat, montant:amount}); $('budget-categorie').value=''; $('budget-montant').value='';
    saveAll(); refreshAll();
  }
  function delBudget(id){
    const b = budgets.find(x=>x.id===id); if(!b) return;
    if(!confirm(`Supprimer le budget "${b.categorie}" ?`)) return;
    budgets = budgets.filter(x=>x.id!==id);
    for(const t of transactions){ if(t.categorie===b.categorie) t.categorie=null; }
    saveAll(); refreshAll();
  }
  function renderBudgets(){
    const wrap=$('budgets-list');
    if(budgets.length===0){ wrap.innerHTML = `<div class="empty">Aucun budget. Créez votre premier budget ci-dessus.</div>`; return; }
    wrap.innerHTML = budgets.map(b=>{
      const dep = currentMonthUsage(b.categorie);
      const pct = Math.min(100, b.montant>0? (dep/b.montant)*100 : 0);
      const reste = Math.max(0, b.montant - dep);
      let bar='ok', status='✅ Dans les limites';
      if(pct>=100){ bar='bad'; status='🚨 Dépassé'; }
      else if(pct>=80){ bar='warn'; status='⚠️ Vigilance'; }
      return `<div class="budget-item">
        <div class="budget-head"><div><b>📂 ${escapeHtml(b.categorie)}</b></div><div><b>${fmtAbs(b.montant)}/mois</b></div>
          <div class="actions"><button class="btn red" onclick="delBudget(${b.id})">🗑️</button></div></div>
        <div class="progress"><div class="bar ${bar}" style="width:${pct.toFixed(0)}%"></div></div>
        <div class="row"><span><b>Dépensé:</b> ${fmtAbs(dep)}</span><span><b>Reste:</b> ${fmtAbs(reste)}</span><span><b>${pct.toFixed(0)}%</b></span></div>
        <div style="font-weight:700; color:${bar==='bad'?'#f44336':bar==='warn'?'#f57c00':'#2e7d32'}">${status}</div>
      </div>`;
    }).join('');
  }

  // ====== RECHERCHE ======
  function search(){
    const q = ($('search-input').value||'').toLowerCase();
    const box = $('search-results');
    if(!q){ box.innerHTML=''; return; }
    const res = transactions.filter(t=>(t.description||'').toLowerCase().includes(q) || (t.categorie||'').toLowerCase().includes(q));
    renderHistoryList(res);
  }

  // ====== IMPORT CSV (AUTO & MANUEL) ======
  function detectDelimiter(line){
    const cands=[',',';','\t','|']; let best=',', bestCount=0;
    for(const d of cands){ const count = (line.match(new RegExp('\\'+d,'g'))||[]).length; if(count>bestCount){ best=d; bestCount=count; } }
    return best;
  }
  function splitLine(line, delim){
    const out=[]; let cur=''; let q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='\"'){
        if(q && line[i+1]==='\"'){ cur+='\"'; i++; } else q=!q;
      }else if(ch===delim && !q){ out.push(cur); cur=''; }
      else{ cur+=ch; }
    }
    out.push(cur);
    return out;
  }
  function buildHeadersAndRows(text){
    const raw = text.replace(/^\uFEFF/,'').replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(x=>x.trim().length>0);
    if(raw.length<1) return null;
    const delim = detectDelimiter(raw[0]);
    const headers = splitLine(raw[0],delim).map(h=>h.replace(/^["']|["']$/g,'').trim());
    const rows = [];
    for(let r=1;r<raw.length;r++){ rows.push(splitLine(raw[r],delim)); }
    return {headers, rows, delim};
  }
  function autoIndex(headers){
    const low = headers.map(h=>h.toLowerCase());
    const idx = (names)=> low.findIndex(h=> names.some(n=> h.includes(n)));
    return {
      iDate: idx(['date','jour']),
      iDesc: idx(['description','libelle','libellé','desc']),
      iMontant: idx(['montant','amount','prix','somme']),
      iDebit: idx(['debit','débit']),
      iCredit: idx(['credit','crédit']),
      iCat: idx(['categorie','catégorie','budget','type'])
    };
  }
  function parseAuto(text){
    const parsed = buildHeadersAndRows(text); if(!parsed) throw new Error('Fichier vide');
    csvRaw = parsed;
    const H = autoIndex(parsed.headers);
    if(H.iDate===-1 || H.iDesc===-1 || (H.iMontant===-1 && H.iDebit===-1 && H.iCredit===-1)){
      throw new Error('Colonnes requises manquantes (Date, Description, Montant ou Débit/Crédit)');
    }
    const rows=[];
    for(const cols of parsed.rows){
      const date = parseMaybeDate(cols[H.iDate]); if(!date) continue;
      const desc = (cols[H.iDesc]||'').toString().replace(/^["']|["']$/g,'').trim(); if(!desc) continue;
      let montant = NaN;
      if(H.iMontant!==-1) montant = sanitizeNumber((cols[H.iMontant]||'').toString());
      else{
        const debit = sanitizeNumber(cols[H.iDebit]||'');
        const credit = sanitizeNumber(cols[H.iCredit]||'');
        if(!isNaN(debit) && debit>0) montant = -Math.abs(debit);
        else if(!isNaN(credit) && credit>0) montant = Math.abs(credit);
      }
      if(isNaN(montant)) continue;
      const cat = H.iCat!==-1 ? (cols[H.iCat]||'').toString().trim() : '';
      rows.push({date, description:desc, montant, categorie:cat});
    }
    return rows;
  }
  function buildMappingUI(headers){
    const selects = ['map-date','map-desc','map-amount','map-debit','map-credit','map-cat'];
    for(const id of selects){
      const el = $(id); el.innerHTML = '<option value="">— Aucune —</option>' + headers.map((h,i)=>`<option value="${i}">${escapeHtml(h)}</option>`).join('');
    }
    const H = autoIndex(headers);
    if(H.iDate!==-1) $('map-date').value = H.iDate;
    if(H.iDesc!==-1) $('map-desc').value = H.iDesc;
    if(H.iMontant!==-1) $('map-amount').value = H.iMontant;
    if(H.iDebit!==-1) $('map-debit').value = H.iDebit;
    if(H.iCredit!==-1) $('map-credit').value = H.iCredit;
    if(H.iCat!==-1) $('map-cat').value = H.iCat;
  }
  function parseWithMapping(parsed){
    const iDate = parseInt($('map-date').value,10);
    const iDesc = parseInt($('map-desc').value,10);
    const iAmount = parseInt($('map-amount').value,10);
    const iDebit = parseInt($('map-debit').value,10);
    const iCredit = parseInt($('map-credit').value,10);
    const iCat = parseInt($('map-cat').value,10);
    if(!(iDate>=0) || !(iDesc>=0) || (! (iAmount>=0) && !(iDebit>=0) && !(iCredit>=0))){
      throw new Error('Mapping incomplet : Date, Description, et Montant ou Débit/Crédit sont requis.');
    }
    const rows=[];
    for(const cols of parsed.rows){
      const date = parseMaybeDate(cols[iDate]); if(!date) continue;
      const desc = (cols[iDesc]||'').toString().replace(/^["']|["']$/g,'').trim(); if(!desc) continue;
      let montant = NaN;
      if(iAmount>=0) montant = sanitizeNumber((cols[iAmount]||'').toString());
      else{
        const debit = (iDebit>=0) ? sanitizeNumber(cols[iDebit]||'') : NaN;
        const credit = (iCredit>=0) ? sanitizeNumber(cols[iCredit]||'') : NaN;
        if(!isNaN(debit) && debit>0) montant = -Math.abs(debit);
        else if(!isNaN(credit) && credit>0) montant = Math.abs(credit);
      }
      if(isNaN(montant)) continue;
      const cat = (iCat>=0) ? (cols[iCat]||'').toString().trim() : '';
      rows.push({date, description:desc, montant, categorie:cat});
    }
    return rows;
  }

  function handleFile(file){
    const reader = new FileReader();
    reader.onload = (e)=>{
      try{
        const text = e.target.result;
        const mode = document.querySelector('input[name="mode"]:checked')?.value || 'auto';
        csvRaw = buildHeadersAndRows(text);
        if(!csvRaw) throw new Error('Fichier vide');
        // Always enable manual mapping UI
        buildMappingUI(csvRaw.headers);
        $('manual-mapping').style.display = (mode==='manuel') ? 'block' : 'none';

        if(mode==='auto'){
          csvRows = parseAuto(text);
        }else{
          csvRows = parseWithMapping(csvRaw);
        }
        $('import-results').style.display='block';
        $('import-results').textContent = `✅ Fichier prêt : ${csvRows.length} ligne(s) détectée(s).`;
        $('btn-import').disabled = csvRows.length===0;
        pendingImport = csvRows;
      }catch(err){
        $('import-results').style.display='block';
        $('import-results').textContent = '❌ ' + err.message;
        $('btn-import').disabled = true; pendingImport=null;
      }
    };
    reader.readAsText(file);
  }
  function doImport(){
    if(!pendingImport || pendingImport.length===0){ alert('Aucune donnée à importer'); return; }
    let ok=0, skip=0;
    for(const row of pendingImport){
      try{
        const type = row.montant>=0 ? 'revenu' : 'depense';
        const amount = Math.abs(row.montant);
        let cat = null;
        if(type==='depense' && row.categorie){
          const b = budgets.find(x=>x.categorie.toLowerCase()===row.categorie.toLowerCase());
          if(b) cat = b.categorie;
        }
        transactions.unshift({ id: Date.now()+Math.random(), date: row.date.toISOString(), montant: amount, description: row.description, type, categorie: cat });
        ok++;
      }catch{ skip++; }
    }
    saveAll(); refreshAll();
    $('import-results').style.display='block';
    $('import-results').innerHTML = `✅ Import terminé<br>📈 ${ok} transactions importées${skip?`<br>⚠️ ${skip} ligne(s) ignorée(s)`:''}`;
    $('btn-import').disabled = true; csvRows=null; pendingImport=null; $('csvFile').value='';
    setTimeout(()=>activateTab('dashboard'), 600);
  }

  // Preview mapping (10 rows)
  function previewMapping(){
    if(!csvRaw){ alert('Chargez d’abord un fichier.'); return; }
    try{
      const rows = parseWithMapping(csvRaw).slice(0,10);
      const html = '<b>Aperçu (10 lignes)</b><br>' + rows.map(r=>{
        const t = r.montant>=0 ? 'revenu':'dépense';
        return `${new Date(r.date).toLocaleDateString(getLocale())} — ${escapeHtml(r.description)} — ${t} — ${fmt(Math.abs(r.montant))} — ${escapeHtml(r.categorie||'')}`;
      }).join('<br>');
      $('preview-map').style.display='block'; $('preview-map').innerHTML = html;
      // Also stage for import
      csvRows = parseWithMapping(csvRaw);
      pendingImport = csvRows;
      $('import-results').style.display='block';
      $('import-results').textContent = `✅ Mapping manuel détecté : ${csvRows.length} ligne(s).`;
      $('btn-import').disabled = csvRows.length===0;
    }catch(err){
      $('preview-map').style.display='block'; $('preview-map').textContent = '❌ ' + err.message;
    }
  }

  // ====== EXPORT ======
  function toCSV(rows){
    if(!rows || rows.length===0) return '';
    const headers = Object.keys(rows[0]);
    const esc = (v)=>{
      const s = (v===null||v===undefined)?'':String(v);
      if(/[",\n;]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
      return s;
    };
    return headers.join(',') + '\n' + rows.map(r=> headers.map(h=>esc(r[h])).join(',')).join('\n');
  }
  function download(filename, text){
    const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }
  function exportTxRows(){
    return transactions.map(t=>({
      id:t.id, date:new Date(t.date).toISOString().slice(0,10),
      description:t.description, type:t.type,
      montant:(t.type==='depense'?-t.montant:t.montant),
      categorie:t.categorie||''
    }));
  }
  function exportBudRows(){
    return budgets.map(b=>({id:b.id, categorie:b.categorie, montant:b.montant}));
  }
  function exportTxCSV(){ download('transactions.csv', toCSV(exportTxRows())); }
  function exportTxJSON(){ download('transactions.json', JSON.stringify(transactions,null,2)); }
  function exportBudCSV(){ download('budgets.csv', toCSV(exportBudRows())); }
  function exportBudJSON(){ download('budgets.json', JSON.stringify(budgets,null,2)); }

  function exportTxXLSX(){
    try{
      const ws = XLSX.utils.json_to_sheet(exportTxRows());
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Transactions');
      XLSX.writeFile(wb, 'transactions.xlsx');
    }catch(e){ alert('XLSX indisponible : ' + e.message); }
  }
  function exportBudXLSX(){
    try{
      const ws = XLSX.utils.json_to_sheet(exportBudRows());
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Budgets');
      XLSX.writeFile(wb, 'budgets.xlsx');
    }catch(e){ alert('XLSX indisponible : ' + e.message); }
  }

  function resetData(){
    if(!confirm('Tout réinitialiser (transactions + budgets) ?')) return;
    transactions=[]; budgets=[]; saveAll(); refreshAll();
  }

  // ====== RÉCURRENCE (heuristique) ======
  function isRecurring(t){
    const key = (t.description||'').toLowerCase().replace(/\s+/g,' ').trim().slice(0,40);
    const months = new Map();
    for(const x of transactions){
      if(x.type!==t.type) continue;
      const k = (x.description||'').toLowerCase().replace(/\s+/g,' ').trim().slice(0,40);
      if(k===key && Math.abs(x.montant - t.montant) <= t.montant*0.1){
        const d = new Date(x.date);
        const m = `${d.getFullYear()}-${d.getMonth()+1}`;
        months.set(m, true);
      }
    }
    return months.size>=3;
  }

  // ====== GRAPHIQUES ======
  function renderCharts(){
    try{
      const catMap = monthSpendByCat();
      const labels = Object.keys(catMap);
      const data = labels.map(k=>catMap[k]);
      const ctx1 = $('pie-categories').getContext('2d');
      charts.pie?.destroy();
      charts.pie = new Chart(ctx1, {
        type:'pie',
        data:{ labels, datasets:[{ data }]},
        options:{
          plugins:{ legend:{position:'bottom'} },
          onClick: (e, el)=>{
            if(!el.length) return;
            const idx = el[0].index; const cat = labels[idx];
            const start = startOfMonth();
            const items = transactions.filter(t=> t.type==='depense' && (t.categorie||'— Sans budget')===cat && new Date(t.date)>=start);
            $('chart-detail').innerHTML = items.map(t=> lineHTML(t,true)).join('');
            document.querySelector('#charts details').open = true;
          }
        }
      });

      const series = monthSeries(6);
      const ctx2 = $('line-mensuel').getContext('2d');
      charts.line?.destroy();
      charts.line = new Chart(ctx2, {
        type:'line',
        data:{
          labels: series.map(s=>s.label),
          datasets:[
            {label:'Revenus', data: series.map(s=>s.revenus), tension:.25},
            {label:'Dépenses', data: series.map(s=>s.depenses), tension:.25},
            {label:'Solde', data: series.map(s=>s.solde), tension:.25}
          ]
        },
        options:{ plugins:{ legend:{position:'bottom'} } }
      });
    }catch(e){ /* ignore Chart.js issues */ }
  }

  function refreshAll(){
    refreshKPIs();
    renderAlerts();
    renderRecent();
    renderBudgets();
    renderCharts();
    updateCategorySelect();
    renderHistoryTab();
  }
  function updateCategorySelect(){ $('categorie').innerHTML = optionsBudget(''); }

  function renderHistoryTab(){
    $('history-mode').value = state.historyMode;
    $('history-filter').value = state.tableFilter;
    $('history-pagesize').value = String(state.tablePageSize);
    if(state.historyMode==='table'){
      $('history-list').hidden = true;
      $('history-table-wrap').hidden = false;
      renderHistoryTable();
    }else{
      $('history-list').hidden = false;
      $('history-table-wrap').hidden = true;
      // Apply filter even in list mode for convenience
      const q = state.tableFilter.trim().toLowerCase();
      let rows = transactions.slice();
      if(q){ rows = rows.filter(t => (t.description||'').toLowerCase().includes(q) || (t.categorie||'').toLowerCase().includes(q)); }
      renderHistoryList(rows);
    }
  }

  // ====== NAVIGATION ======
  function activateTab(name){
    for(const el of document.querySelectorAll('.tab')) el.hidden = true;
    for(const b of document.querySelectorAll('.tab-btn')) b.setAttribute('aria-selected','false');
    $(name).hidden = false;
    document.querySelector(`.tab-btn[data-tab="${name}"]`)?.setAttribute('aria-selected','true');
    const prefs = JSON.parse(localStorage.getItem(LS_PREF)||'{}');
    prefs.lastTab = name;
    localStorage.setItem(LS_PREF, JSON.stringify(prefs));
  }

  // ====== EVENTS ======
  document.addEventListener('DOMContentLoaded', ()=>{
    // Tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=> activateTab(btn.dataset.tab));
    });

    // Add tx
    $('btn-add-revenu').addEventListener('click', ()=> addTx('revenu'));
    $('btn-add-depense').addEventListener('click', ()=> addTx('depense'));

    // Budgets
    $('btn-add-budget').addEventListener('click', addBudget);

    // Search
    $('search-input').addEventListener('keyup', search);

    // History controls
    $('history-mode').addEventListener('change', (e)=>{ state.historyMode = e.target.value; saveAll(); renderHistoryTab(); });
    $('history-filter').addEventListener('input', (e)=>{ state.tableFilter = e.target.value; state.tablePage=1; renderHistoryTab(); });
    $('history-pagesize').addEventListener('change', (e)=>{ state.tablePageSize = parseInt(e.target.value,10)||10; state.tablePage=1; renderHistoryTab(); });

    // Sort headers
    document.querySelectorAll('#history-table-wrap thead th[data-key]').forEach(th=>{
      th.addEventListener('click', ()=>{
        const key = th.dataset.key;
        if(state.tableSort.key===key){ state.tableSort.dir = (state.tableSort.dir==='asc'?'desc':'asc'); }
        else{ state.tableSort = {key, dir:'asc'}; }
        renderHistoryTable();
      });
    });

    // Import: click to open file
    const drop = $('drop'); const file = $('csvFile');
    drop.addEventListener('click', ()=> file.click());
    drop.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragleave', (e)=>{ e.preventDefault(); drop.classList.remove('drag'); });
    drop.addEventListener('drop', (e)=>{
      e.preventDefault(); drop.classList.remove('drag');
      const f = e.dataTransfer.files[0];
      if(!f){return;}
      if(!/(\.csv$)|(^text\/csv$)/i.test(f.type) && !/\.csv$/i.test(f.name)){
        $('import-results').style.display='block'; $('import-results').textContent='❌ Sélectionnez un fichier .csv';
        return;
      }
      handleFile(f);
    });
    file.addEventListener('change', ()=>{ const f = file.files[0]; if(!f) return; handleFile(f); });

    // Toggle manual/auto mapping
    document.querySelectorAll('input[name="mode"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        const mode = document.querySelector('input[name="mode"]:checked')?.value || 'auto';
        $('manual-mapping').style.display = (mode==='manuel') ? 'block' : 'none';
        // Reset counters
        $('import-results').style.display='none'; $('btn-import').disabled = true;
        csvRows = null; pendingImport = null;
        // If a file is already selected, re-parse it in the new mode
        const f = $('csvFile').files[0];
        if(f) handleFile(f);
      });
    });
    $('btn-preview-map').addEventListener('click', previewMapping);
    $('btn-import').addEventListener('click', doImport);
    $('btn-clear-file').addEventListener('click', ()=>{
      $('csvFile').value=''; csvRows=null; pendingImport=null;
      $('import-results').style.display='none'; $('preview-map').style.display='none';
    });

    // Export
    $('export-tx-csv').addEventListener('click', exportTxCSV);
    $('export-tx-json').addEventListener('click', exportTxJSON);
    $('export-tx-xlsx').addEventListener('click', exportTxXLSX);
    $('export-bud-csv').addEventListener('click', exportBudCSV);
    $('export-bud-json').addEventListener('click', exportBudJSON);
    $('export-bud-xlsx').addEventListener('click', exportBudXLSX);
    $('reset-data').addEventListener('click', resetData);

    // Prefs
    $('save-prefs').addEventListener('click', ()=>{
      const prefs = JSON.parse(localStorage.getItem(LS_PREF)||'{}');
      prefs.defaultTab = $('pref-default-tab').value;
      prefs.locale = $('pref-locale').value;
      prefs.historyMode = state.historyMode;
      localStorage.setItem(LS_PREF, JSON.stringify(prefs));
      alert('Réglages enregistrés.'); refreshAll();
    });

    // Shortcuts
    document.addEventListener('keydown', (e)=>{
      const mod = e.metaKey || e.ctrlKey;
      if(!mod) return;
      if(e.key.toLowerCase()==='k'){ e.preventDefault(); activateTab('search'); $('search-input').focus(); }
      if(e.key.toLowerCase()==='e'){ e.preventDefault(); activateTab('export'); }
      if(e.key.toLowerCase()==='i'){ e.preventDefault(); activateTab('import'); }
    });

    loadAll();
    const last = (JSON.parse(localStorage.getItem(LS_PREF)||'{}').lastTab)||null;
    if(last) activateTab(last);
  });
  </script>
</body>
</html>
